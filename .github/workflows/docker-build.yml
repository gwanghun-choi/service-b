name: Build and Push Docker Image (service-b)

on:
  push:
    branches: ["main"]   # main 브랜치에 push 될 때마다 실행

permissions:
  contents: read         # 소스코드 읽기
  packages: write        # GHCR(컨테이너 레지스트리)에 push 권한

jobs:
  build-and-push:
    runs-on: ubuntu-latest   # GitHub이 제공하는 Ubuntu VM에서 실행

    steps:
      # 1) 소스 코드 체크아웃
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) JDK 17 설치 (Temurin)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3) gradlew 실행권한 부여 (리눅스에서는 필요)
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4) Gradle로 JAR 빌드
      - name: Build JAR with Gradle
        run: ./gradlew clean bootJar

      # 5) GHCR 로그인 (GITHUB_TOKEN 사용)
      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # 6) Docker 이미지 빌드
      - name: Build Docker image
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/service-b
          TAG=${{ github.sha }}
          echo "Building image: $IMAGE_NAME:$TAG"
          docker build -t $IMAGE_NAME:$TAG .

      # 7) Docker 이미지 GHCR에 push
      - name: Push Docker image
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/service-b
          TAG=${{ github.sha }}
          echo "Pushing image: $IMAGE_NAME:$TAG"
          docker push $IMAGE_NAME:$TAG
